{% extends 'layout.html' %}

{% block title %}Event Tasks - QCS Event Management{% endblock %}

{% block head %}
<style>
    .kanban-board {
        display: grid;
        gap: 1.5rem;
    }
    @media (min-width: 992px) {
        .kanban-board {
            grid-template-columns: repeat(3, 1fr);
        }
    }
    .kanban-column {
        background: #f8f9fa;
        border-radius: 0.75rem;
        border: 1px solid #dee2e6;
        display: flex;
        flex-direction: column;
        max-height: 70vh;
    }
    .kanban-column-header {
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
    }
    .kanban-column-body {
        padding: 1rem;
        overflow-y: auto;
        flex-grow: 1;
    }
    .kanban-card {
        background: #fff;
        border-radius: 0.5rem;
        border: 1px solid rgba(0,0,0,0.1);
        padding: 0.75rem 0.9rem;
        margin-bottom: 0.75rem;
        cursor: move;
        box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        transition: box-shadow 0.2s ease;
    }
    .kanban-card.dragging {
        opacity: 0.6;
        box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }
    .kanban-card.overdue {
        border-left: 4px solid #dc3545;
    }
    .kanban-card.upcoming {
        border-left: 4px solid #ffc107;
    }
    .kanban-card.completed {
        border-left: 4px solid #198754;
        background: rgba(25, 135, 84, 0.08);
    }
    .kanban-column-body.over {
        background: rgba(13,110,253,0.08);
    }
    .task-meta {
        font-size: 0.78rem;
        color: #6c757d;
    }
    .task-chip {
        display: inline-flex;
        align-items: center;
        background: #e9ecef;
        border-radius: 999px;
        padding: 0.1rem 0.6rem;
        font-size: 0.7rem;
        margin-right: 0.4rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-tasks me-2"></i>{{ event.event_name }} Tasks</h1>
    <div class="d-flex gap-2">
        <a href="{{ url_for('calendar.view_event', event_id=event.event_id) }}" class="btn btn-outline-secondary">
            <i class="fas fa-eye me-1"></i>View Event
        </a>
        <a href="{{ url_for('calendar.calendar') }}" class="btn btn-outline-secondary">
            <i class="fas fa-calendar-alt me-1"></i>Calendar
        </a>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newTaskModal">
            <i class="fas fa-plus-circle me-1"></i>New Task
        </button>
    </div>
</div>

<div class="card shadow-sm mb-4" id="taskProgressCard" data-completed="{{ summary.completed }}" data-total="{{ summary.total }}">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
                <strong>{{ summary.completed }}</strong> of <strong>{{ summary.total }}</strong> tasks completed
            </div>
            <small class="text-muted"><i class="fas fa-calendar-day me-1"></i>{{ event.event_date }}</small>
        </div>
        <div class="progress">
            <div class="progress-bar bg-success" role="progressbar" style="width: {{ summary.percent }}%" aria-valuenow="{{ summary.percent }}" aria-valuemin="0" aria-valuemax="100">
                {{ summary.percent }}%
            </div>
        </div>
    </div>
</div>

<div class="kanban-board" id="taskBoard" data-event-id="{{ event.event_id }}" data-change-status-url="{{ url_for('tasks.api_update_task_status', task_id=0) }}" data-csrf="{{ csrf_token() }}">
    {% for column in status_columns %}
    <div class="kanban-column" data-status="{{ column.key }}">
        <div class="kanban-column-header">
            <span>{{ column.label }}</span>
            <span class="badge bg-secondary" data-status-count="{{ column.key }}">{{ column.tasks|length }}</span>
        </div>
        <div class="kanban-column-body" data-status="{{ column.key }}">
            {% for task in column.tasks %}
            <div class="kanban-card {% if task.is_overdue %}overdue{% elif task.is_upcoming %}upcoming{% endif %} {% if task.status == 'completed' %}completed{% endif %}" draggable="true" data-task-id="{{ task.id }}">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="fw-semibold">{{ task.description }}</div>
                    <div class="d-flex gap-1">
                        <button class="btn btn-sm btn-outline-secondary edit-task-btn" data-bs-toggle="modal" data-bs-target="#editTaskModal"
                                data-task-id="{{ task.id }}"
                                data-task-description="{{ task.description }}"
                                data-task-due-date="{{ task.due_date }}"
                                data-task-assigned-to="{{ task.assigned_to }}"
                                data-task-status="{{ task.status }}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-task-btn" data-bs-toggle="modal" data-bs-target="#deleteTaskModal"
                                data-task-id="{{ task.id }}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="task-meta">
                    {% if task.due_date %}
                    <span class="task-chip">
                        <i class="fas fa-clock me-1"></i>{{ task.due_date }}
                    </span>
                    {% endif %}
                    {% if task.assigned_display %}
                    <span class="task-chip">
                        <i class="fas fa-user me-1"></i>{{ task.assigned_display }}
                    </span>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="text-muted small">No tasks here yet.</div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- New Task Modal -->
<div class="modal fade" id="newTaskModal" tabindex="-1" aria-labelledby="newTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newTaskModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>Add New Task
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="newTaskForm" action="{{ url_for('tasks.add_event_task', event_id=event.event_id) }}" method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="task_description" class="form-label">Task Description*</label>
                        <input type="text" class="form-control" id="task_description" name="description" required>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="due_date" class="form-label">Due Date</label>
                            <input type="date" class="form-control" id="due_date" name="due_date">
                        </div>
                        <div class="col-md-6">
                            <label for="task_status" class="form-label">Status</label>
                            <select class="form-select" id="task_status" name="status">
                                {% for key, label in status_config %}
                                <option value="{{ key }}" {% if key == 'pending' %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label for="assigned_to" class="form-label">Assign To</label>
                        <select class="form-select" id="assigned_to" name="assigned_to">
                            <option value="">Unassigned</option>
                            {% for user in users %}
                            <option value="{{ user.id }}">{{ user.full_name or user.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Save Task
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Task Modal -->
<div class="modal fade" id="editTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editTaskForm" method="post" action="">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Task Description*</label>
                        <input type="text" class="form-control" name="description" id="edit_task_description" required>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Due Date</label>
                            <input type="date" class="form-control" name="due_date" id="edit_task_due_date">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Status</label>
                            <select class="form-select" name="status" id="edit_task_status">
                                {% for key, label in status_config %}
                                <option value="{{ key }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="form-label">Assign To</label>
                        <select class="form-select" name="assigned_to" id="edit_task_assigned_to">
                            <option value="">Unassigned</option>
                            {% for user in users %}
                            <option value="{{ user.id }}">{{ user.full_name or user.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Task</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Task Modal -->
<div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Delete Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="deleteTaskForm" method="post" action="">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <p class="mb-0">Are you sure you want to delete this task?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const editTaskModal = document.getElementById('editTaskModal');
        if (editTaskModal) {
            editTaskModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                if (!button) return;
                const taskId = button.getAttribute('data-task-id');
                const form = editTaskModal.querySelector('form');
                form.action = `{{ url_for('tasks.edit_task', task_id=0)[:-1] }}${taskId}`;
                form.querySelector('#edit_task_description').value = button.getAttribute('data-task-description') || '';
                form.querySelector('#edit_task_due_date').value = button.getAttribute('data-task-due-date') || '';
                form.querySelector('#edit_task_assigned_to').value = button.getAttribute('data-task-assigned-to') || '';
                form.querySelector('#edit_task_status').value = button.getAttribute('data-task-status') || 'pending';
            });
        }

        const deleteTaskModal = document.getElementById('deleteTaskModal');
        if (deleteTaskModal) {
            deleteTaskModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                if (!button) return;
                const taskId = button.getAttribute('data-task-id');
                const form = deleteTaskModal.querySelector('form');
                form.action = `{{ url_for('tasks.delete_task', task_id=0)[:-1] }}${taskId}`;
            });
        }
    });
</script>
{% endblock %}
